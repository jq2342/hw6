---
title: "p8105_hw6_jq2342"
author: "Junyu QI"
date: "`r Sys.Date()`"
output: github_document
---

### Problem 2

```{r}
library(tidyverse)
```

> Create a `city_state` variable (e.g. \"Baltimore, MD\"), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO -- these don\'t report victim race. Also omit Tulsa, AL -- this is a data entry mistake. For this problem, limit your analysis those for whom `victim_race` is `white` or `black`. Be sure that`victim_age` is numeric.

```{r}
homicide=
read_csv("./data/homicide-data.csv") %>%
  janitor:: clean_names() %>%
  unite("city_state", city:state, sep=", ", remove=FALSE) %>%
  select (-city, -state) %>%
  mutate(status= case_when(disposition %in% c("Closed without arrest","Open/No arrest") ~"unsolved",  disposition %in% "Closed by arrest" ~"solved"),
  victim_age=as.numeric(victim_age)) %>%
  filter(!city_state  %in% c("Dallas, TX","Phoenix, AZ", "Kansas City, MO", " Tulsa, AL" )) %>%
  filter(victim_race %in% c("White", "Black"))
```

> For the city of Baltimore, MD, use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. Save the output of `glm` as an R object; apply the `broom::tidy` to this object; and obtain the estimate and confidence interval of the adjusted **odds ratio** for solving homicides comparing male victims to female victims keeping all other variables fixed.

```{r}
Homicide_Bal=
  homicide %>%
  filter(city_state %in% "Baltimore, MD") %>%
  mutate(
    victim_sex = as.factor(victim_sex),
    victim_race = as.factor(victim_race),
    status=as.factor(status))

Homicide_Bal_rg= glm(status ~ victim_age + victim_sex + victim_race, family=binomial(), data   =Homicide_Bal) %>%
  broom::tidy () %>%
  mutate(OR = exp(estimate), ci_lower=exp(estimate-1.96*std.error), ci_upper=exp(estimate+1.96*std.error)) %>%
  select(term, estimate, ci_lower, ci_upper, OR) %>%
  filter(term %in% "victim_sexMale") %>%
   knitr::kable(digits = 3) 
```

> Now run `glm` for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. Do this within a \"tidy\" pipeline, making use of `purrr::map`, list columns, and `unnest` as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
homicide_nested =
  homicide %>% 
  drop_na() %>%
  filter(!city_state %in% "Tulsa, AL") %>%
   mutate(
    victim_sex = as.factor(victim_sex),
    victim_race = as.factor(victim_race),
    status=as.factor(status),
    victim_age=as.numeric(victim_age)) %>%
  nest(data = -city_state) 
  

homicide_rg=
homicide_nested %>%
  mutate(
    models = map(data, ~glm(status ~ victim_age + victim_sex + victim_race, family=binomial(), data=.x)),
    results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results)  %>%
  filter(term %in% "victim_sexMale")%>%
  mutate(OR = exp(estimate), ci_lower=exp(estimate-1.96*std.error), ci_upper=exp(estimate+1.96*std.error)) %>%
  select(city_state, term, estimate, ci_lower, ci_upper, OR)
```

> Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r}
homicide_rg %>% 
  ggplot(aes(x =reorder(city_state,OR), y = OR)) + 
  geom_point() + 
  geom_errorbar(width=.1, aes(ymin=ci_lower, ymax=ci_upper)) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1)) +
  labs(y= "Odds Ratio", x = "City, State") 

```

As showing in the plot the Odds ratio comparing male victim to female victim range from approximately 0.5-4. In Albuquerque, NM where the odds ratio is the lowest, the odds of become a victim for male is approx. 0.5 times the odds for female. In New York, NY where the odds ratio is the highest, the odds of becoming a victim for male is approx. 3.8 times the odds for female.
